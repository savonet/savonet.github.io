<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/png" href="/assets/img/favicon.ico">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>Liquidsoap</title>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
    <!-- Extra details for Live View on GitHub Pages -->
    <!-- Canonical SEO -->
    <link rel="canonical" href="https://www.liquidsoap.info/" />
    <!--  Social tags      -->
    <meta name="keywords" content="radio, audio, video, streaming, icecast, shoutcast">
    <meta name="description" content="Swiss-army knife for multimedia streaming">
    <!-- Schema.org markup for Google+ -->
    <meta itemprop="name" content="Liquidsoap Streaming Language">
    <meta itemprop="description" content="Swiss-army knife for multimedia streaming">
    <!-- Twitter Card data -->
    <meta name="twitter:card" content="product">
    <meta name="twitter:site" content="@LiquidsoapMedia">
    <meta name="twitter:title" content="Liquidsoap Streaming Language">
    <meta name="twitter:description" content="Swiss-army knife for multimedia streaming">
    <meta name="twitter:creator" content="@LiquidsoapMedia">
    <meta name="twitter:image" content="https://www.liquidsoap.info//assets/img/bottle_invert.png">
    <!--     Fonts and icons     -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
    <!-- CSS Files -->
    <link href="/assets/css/custom.css" rel="stylesheet" />
    <link href="/assets/css/material-kit.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <!-- Documentation extras -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
    <link rel="stylesheet" href="/assets/demo/docs.min.css">
    <style>
    .navbar-absolute-logo {
      padding-left: 45px;
    }

    .navbar-absolute-logo img {
      position: absolute;
      left: 15px;
      margin-top: -6px;
    }

    body {
      background: white;
    }

    p {
        font-size: 16px;
        text-align: justify;
    }
    </style>
    <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    </style>
  </head>

  <body class="bd-docs" data-spy="scroll" data-target=".bd-sidenav-active">
    <a id="skippy" class="sr-only sr-only-focusable" href="#content">
      <div class="container">
        <span class="skiplink-text">Skip to main content</span>
      </div>
    </a>
    <header class="navbar navbar-expand navbar-dark bg-primary flex-column flex-md-row bd-navbar">
      <a class="navbar-brand mr-0 mr-md-2 navbar-absolute-logo" href="/doc-2.3.1">
        <svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 600 600" focusable="false" style="width: 25px; height: 25px;">
          <title>Liquidsoap</title>
          <style type="text/css">
.st0{fill:#FFFFFF;}
          </style>
          <g>
          <path class="st0" d="M102.4,593.8c-0.7-2.8-3.4-2.5-5.3-3.3c-24.6-10.2-37.2-28.7-37.2-55.6c-0.1-72.1,0-144.2,0-216.3
          c0-52.3,0-104.6,0-156.9c0-37.6,23.1-60.9,60.6-61.1c12-0.1,23.9-0.2,35.9,0c15.7,0.3,26.7,10.1,26.3,23
          c-0.4,12.5-11.1,21.5-26.3,21.8c-12,0.2-23.9-0.1-35.9,0.1c-11.8,0.1-15.6,3.7-15.6,15.3c-0.1,124.4,0,248.8-0.1,373.2
          c0,10.3,4.5,15.1,14.8,15.1c69.1-0.1,138.2,0,207.3-0.1c12.3,0,15.5-3.7,15.5-17.7c0-74.7,0-149.4,0-224.2c0-47.8,0-95.6,0-143.5
          c0-15.2-3-18.1-18.4-18.2c-10.8,0-21.7,0.1-32.5,0c-16-0.2-26.7-9.4-26.6-22.5c0.1-13,10.9-22.1,26.9-22.3
          c13.4-0.2,26.9-0.3,40.3,0.1c30.8,1,54.9,24.5,55,55.2c0.3,127.4,0.3,254.8,0.1,382.2c0,25.5-15.8,45.7-40.2,53.3
          c-1.7,0.5-3.8,0-4.5,2.4C262.3,593.8,182.4,593.8,102.4,593.8z"/>
          <path class="st0" d="M537.4,212.6c-16.8,23-56.5,16.5-68.6-9.5c-8-17.2-12.4-32.7-12-54.5c4.6,4.1,8.3,7.5,12.1,10.7
          c10.3,8.6,21,14,35.5,11.8c12.5-1.9,21.5,6,28.2,16.3c2,3,1.3,7.3,4.8,9.5C537.4,202.2,537.4,207.4,537.4,212.6z"/>
          <path class="st0" d="M200.6,230.4c0-55.3,0-110.5,0-165.8c0-40.7,22.3-62.7,63.2-62.7c50.4,0,100.8,0,151.3,0
          c36.1,0,59.1,21.9,60.4,57.7c0.5,13.1,0.4,26.1,0,39.2c-0.4,15.1-10.1,25.8-22.5,25.7c-12-0.1-21.6-10.1-22.3-24.8
          c-0.6-12.7-0.4-25.4-0.1-38.1c0.2-10.4-4.5-14.9-14.9-14.9c-51.5,0.1-103.1,0-154.6,0.1c-12.7,0-15.5,3.2-15.5,17.5
          c0,105.3,0,210.6,0,316c0,7.8,0.1,15.7,0,23.5c-0.2,17.5-9.4,28.9-23,28.6c-13.5-0.3-21.9-10.9-21.9-28.3
          C200.6,346.2,200.6,288.3,200.6,230.4z"/>
          </g>
        </svg>
        Liquidsoap
      </a>
      <ul class="navbar-nav flex-row d-none d-md-flex">
        <li class="nav-item dropdown">
          <a data-versions="dev 2.2.5 2.3.0 2.3.1 2.3.2 2.3.3
2.4.0" data-version="2.3.1" class="nav-item nav-link dropdown-toggle mr-md-2" href="#" id="liq-version" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            2.3.1
          </a>
          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="liq-version" id="liq-versions">
          </div>
        </li>
        <li class="nav-item">
          <a class="nav-link p-2" href="https://github.com/savonet/liquidsoap" target="_blank" rel="noopener" aria-label="GitHub">
            <svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 499.36" focusable="false">
              <title>GitHub</title>
              <path d="M256 0C114.64 0 0 114.61 0 256c0 113.09 73.34 209 175.08 242.9 12.8 2.35 17.47-5.56 17.47-12.34 0-6.08-.22-22.18-.35-43.54-71.2 15.49-86.2-34.34-86.2-34.34-11.64-29.57-28.42-37.45-28.42-37.45-23.27-15.84 1.73-15.55 1.73-15.55 25.69 1.81 39.21 26.38 39.21 26.38 22.84 39.12 59.92 27.82 74.5 21.27 2.33-16.54 8.94-27.82 16.25-34.22-56.84-6.43-116.6-28.43-116.6-126.49 0-27.95 10-50.8 26.35-68.69-2.63-6.48-11.42-32.5 2.51-67.75 0 0 21.49-6.88 70.4 26.24a242.65 242.65 0 0 1 128.18 0c48.87-33.13 70.33-26.24 70.33-26.24 14 35.25 5.18 61.27 2.55 67.75 16.41 17.9 26.31 40.75 26.31 68.69 0 98.35-59.85 120-116.88 126.32 9.19 7.9 17.38 23.53 17.38 47.41 0 34.22-.31 61.83-.31 70.23 0 6.85 4.61 14.81 17.6 12.31C438.72 464.97 512 369.08 512 256.02 512 114.62 397.37 0 256 0z" fill="currentColor" fill-rule="evenodd" />
            </svg>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link p-2" href="https://twitter.com/liquidsoapmedia" target="_blank" rel="noopener" aria-label="Twitter">
            <svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 416.32" focusable="false">
              <title>Twitter</title>
              <path d="M160.83 416.32c193.2 0 298.92-160.22 298.92-298.92 0-4.51 0-9-.2-13.52A214 214 0 0 0 512 49.38a212.93 212.93 0 0 1-60.44 16.6 105.7 105.7 0 0 0 46.3-58.19 209 209 0 0 1-66.79 25.37 105.09 105.09 0 0 0-181.73 71.91 116.12 116.12 0 0 0 2.66 24c-87.28-4.3-164.73-46.3-216.56-109.82A105.48 105.48 0 0 0 68 159.6a106.27 106.27 0 0 1-47.53-13.11v1.43a105.28 105.28 0 0 0 84.21 103.06 105.67 105.67 0 0 1-47.33 1.84 105.06 105.06 0 0 0 98.14 72.94A210.72 210.72 0 0 1 25 370.84a202.17 202.17 0 0 1-25-1.43 298.85 298.85 0 0 0 160.83 46.92" fill="currentColor" />
            </svg>
          </a>
        </li>
      </ul>
      <div class="navbar-nav-scroll ml-md-auto ">
        <ul class="navbar-nav bd-navbar-nav flex-row">
          <!--
            <li class="nav-item">
            <a class="nav-link" href=""> <i class="material-icons">card_membership</i> PRO Services </a>
            </li>
            -->
          <li class="nav-item">
            <script async src="https://cse.google.com/cse.js?cx=24f50f6f088994c53"></script>
            <style>
.cse .gsc-control-cse, .gsc-control-cse {
  background-color: transparent;
  border: none;
  width: 300px;
}
            </style>
            <div class="gcse-search"></div>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="https://github.com/savonet/liquidsoap/issues" target="_blank" rel="noopener"><i class="material-icons">star</i> Get Help</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="" target="_blank" rel="noopener"></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="" target="_blank" rel="noopener"></a>
          </li>
        </ul>
      </div>
      <a href="https://github.com/savonet/liquidsoap" class="github-corner" aria-label="View source on Github">
        <svg width="80" height="80" viewBox="0 0 250 250" style="fill:#fff; color:#9c27b0; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
          <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
          <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
          <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
        </svg>
      </a>
      <style>
.github-corner:hover .octo-arm {
  animation: octocat-wave 560ms ease-in-out
}

        @keyframes octocat-wave {
          0%,
          100% {
            transform: rotate(0)
          }
          20%,
          60% {
            transform: rotate(-25deg)
          }
          40%,
          80% {
            transform: rotate(10deg)
          }
        }

        @media (max-width:500px) {
          .github-corner:hover .octo-arm {
            animation: none
          }
          .github-corner .octo-arm {
            animation: octocat-wave 560ms ease-in-out
          }
        }
      </style>
    </header>
    <div class="container-fluid">
      <div class="row flex-xl-nowrap">
        <div class="col-12 col-md-3 col-xl-2 bd-sidebar">
          <nav class="collapse bd-links" id="bd-docs-nav">
            <div class="bd-toc-item active">
              <ul class="nav bd-sidenav">
                <li class="active bd-sidenav-active">
                  <a class="bd-toc-link" href="/doc-2.3.1/install.html">
                    Install
                  </a>
                </li>
                <li>
                  <a href="/doc-2.3.1/migrating.html">
                    Migrating from previous versions
                  </a>
                </li>
                <li class="active bd-sidenav-active">
                  <a class="bd-toc-link" href="#">
                    Starters
                  </a>
                </li>
                <li><a href="/doc-2.3.1/book.html">The book</a></li>
                <li>
                  <a href="/doc-2.3.1/presentations.html">Video Presentations</a>
                </li>
                <li>
                  <a href="/doc-2.3.1/help.html">How to find help</a>
                </li>
                <li>
                  <a href="/doc-2.3.1/faq.html">Frequently Asked Questions</a>
                </li>
                <li><a href="/doc-2.3.1/quick_start.html">Quickstart</a></li>
                <li>
                  <a href="/doc-2.3.1/complete_case.html">Complete case analysis</a>
                </li>
                <li>
                  <a href="/doc-2.3.1/cookbook.html">Cookbook</a>
                </li>
              </ul>
            </div>
            <div class="bd-toc-item active">
              <a class="bd-toc-link" href="#">
                Reference
              </a>
              <ul class="nav bd-sidenav">
                <li>
                  <a href="/doc-2.3.1/language.html">Script language</a></li>
                <li>
                  <a href="/doc-2.3.1/reference.html">Core API</a></li>
                <li>
                  <a href="/doc-2.3.1/reference-extras.html">Extra API</a></li>
                <li>
                  <a href="/doc-2.3.1/reference-deprecated.html">Deprecated API</a></li>
                <li>
                  <a href="/doc-2.3.1/multitrack.html">Multitrack</a></li>
                <li>
                  <a href="/doc-2.3.1/protocols.html">Protocols</a></li>
                <li>
                  <a href="/doc-2.3.1/settings.html">Settings</a></li>
                <li>
                  <a href="/doc-2.3.1/ffmpeg.html">FFmpeg support</a></li>
                <li>
                  <a href="/doc-2.3.1/encoding_formats.html">Encoding formats</a></li>
                <li>
                  <a href="/doc-2.3.1/video.html">Videos streams</a></li>
                <li>
                  <a href="/doc-2.3.1/memory.html">Memory management</a></li>
                <li>
                  <a href="/doc-2.3.1/json.html">JSON import/export</a></li>
                <li>
                  <a href="/doc-2.3.1/xml.html">XML import/export</a></li>
                <li>
                  <a href="/doc-2.3.1/yaml.html">YAML import/export</a></li>
                <li>
                  <a href="/doc-2.3.1/ladspa.html">LADSPA plugins</a></li>
                <li>
                  <a href="/doc-2.3.1/playlist_parsers.html">Playlist parsers</a></li>
              </ul>
            </div>
            <div class="bd-toc-item active">
              <a class="bd-toc-link" href="#">
                Core
              </a>
              <ul class="nav bd-sidenav">
                <li>
                  <a href="/doc-2.3.1/sources.html">Sources</a></li>
                <li>
                  <a href="/doc-2.3.1/clocks.html">Clocks</a></li>
                <li>
                  <a href="/doc-2.3.1/requests.html">Requests</a></li>
                <li>
                  <a href="/doc-2.3.1/protocols-presentation.html">Protocols</a></li>
                <li>
                  <a href="/doc-2.3.1/stream_content.html">Stream contents</a></li>
                <li>
                  <a href="/doc-2.3.1/strings_encoding.html">Strings encoding</a></li>
                <li>
                  <a href="/doc-2.3.1/script_loading.html">Script loading</a></li>
                <li><a href="/doc-2.3.1/phases.html">Execution phases</a></li>
              </ul>
            </div>
            <div class="bd-toc-item active">
              <a class="bd-toc-link" href="#">
                Specific tutorials
              </a>
              <ul class="nav bd-sidenav">
                <li>
                  <a href="/doc-2.3.1/harbor_http.html">Using the HTTP server</a></li>
                <li>
                  <a href="/doc-2.3.1/blank.html">Blank detection</a></li>
                <li>
                  <a href="/doc-2.3.1/metadata.html">Customize metadata</a></li>
                <li>
                  <a href="/doc-2.3.1/seek.html">Seek and cue support</a></li>
                <li>
                  <a href="/doc-2.3.1/external_decoders.html">External decoders</a></li>
                <li>
                  <a href="/doc-2.3.1/external_streams.html">External streams</a></li>
                <li>
                  <a href="/doc-2.3.1/external_encoders.html">External encoders</a></li>
                <li>
                  <a href="/doc-2.3.1/hls_output.html">HLS output</a></li>
                <li>
                  <a href="/doc-2.3.1/http_input.html">HTTP input</a></li>
                <li>
                  <a href="/doc-2.3.1/harbor.html">Harbor input</a></li>
                <li>
                  <a href="/doc-2.3.1/stereotool.html">Stereotool</a></li>
                <li>
                  <a href="/doc-2.3.1/server.html">Using the telnet server</a></li>
                <li>
                  <a href="/doc-2.3.1/icy_metadata.html">ICY metadata update</a></li>
                <li>
                  <a href="/doc-2.3.1/replay_gain.html">Normalization and replay gain</a></li>
                <li>
                  <a href="/doc-2.3.1/request_sources.html">Requests-based sources</a></li>
                <li>
                  <a href="/doc-2.3.1/shoutcast.html">Shoutcast output</a></li>
                <li>
                  <a href="/doc-2.3.1/dynamic_sources.html">Dynamic source creation</a></li>
                <li>
                  <a href="/doc-2.3.1/crossfade.html">Crossfading</a></li>
                <li>
                  <a href="/doc-2.3.1/in_production.html">Using in production</a></li>
              </ul>
              <ul class="nav bd-sidenav">
                <li>
                  <a class="bd-toc-link" href="#">
                    User scripts
                  </a>
                </li>
                <li>
                  <a href="/doc-2.3.1/beets.html">Beets</a></li>
                <li>
                  <a href="/doc-2.3.1/geekradio.html">Geekradio</a></li>
                <li>
                  <a href="/doc-2.3.1/radiopi.html">RadioPi</a></li>
                <li>
                  <a href="/doc-2.3.1/dolebrai.html">Dolebraï</a></li>
                <li>
                  <a href="/doc-2.3.1/frequence3.html">Frequence3</a></li>
                <li>
                  <a href="/doc-2.3.1/video-static.html">Video with a single static image</a></li>
                <li>
                  <a href="/doc-2.3.1/split-cue.html">Split a CUE sheet</a></li>
              </ul>
              <ul class="nav bd-sidenav">
                <li>
                  <a class="bd-toc-link" href="#">
                    Behind the curtains
                  </a>
                </li>
                <li>
                  <a href="/doc-2.3.1/publications.html">Some presentations and publications</a></li>
                <li>
                  <a href="https://github.com/savonet">OCaml libraries</a></li>
                <li class="active bd-sidenav-active">
                  <a class="bd-toc-link" href="/legacy">
                    Legacy website
                  </a>
                </li>
              </ul>
            </div>
          </nav>
        </div>
        <!--
          <div class="d-none d-xl-block col-xl-2 bd-toc">
          <ul class="section-nav">
          <li class="toc-entry toc-h2">
          <a href="#quick-start">Quick start</a>
          <ul>
          <li class="toc-entry toc-h3">
          <a href="#css">CSS</a>
          </li>
          <li class="toc-entry toc-h3">
          <a href="#js">JS</a>
          </li>
          <li class="toc-entry toc-h3">
          <a href="#fonts-and-icons">Fonts and Icons</a>
          </li>
          </ul>
          </li>
          <li class="toc-entry toc-h2">
          <a href="#starter-template">Starter template</a>
          </li>
          </ul>
          </div>
        -->
          <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 bd-content" role="main">
          <h1 id="cookbook"><a href="#cookbook"
class="anchor">Cookbook</a></h1>
<p>The recipes show how to build a source with a particular feature. You
can try short snippets by wrapping the code in an
<code>output(..)</code> operator and passing it directly to
liquidsoap:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>liquidsoap -v &#39;<span class="dt">output</span>(recipe)&#39;</span></code></pre></div>
<p>For longer recipes, you might want to create a short script:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ot">#!/usr/bin/liquidsoap -v</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>log.file.path := <span class="st">&quot;/tmp/&lt;script&gt;.log&quot;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>log.stdout := <span class="dv">true</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="va">recipe</span> = <span class="co"># &lt;fill this&gt;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="dt">output</span>(recipe)</span></code></pre></div>
<p>See the <a href="quick_start.html">quickstart guide</a> for more
information on how to run <a href="index.html">Liquidsoap</a>, on what
is this <code>output(..)</code> operator, etc.</p>
<p>See also the <a href="ffmpeg_cookbook.html">ffmpeg cookbook</a> for
examples specific to the ffmpeg support.</p>
<h2 id="files"><a href="#files" class="anchor">Files</a></h2>
<p>A source which infinitely repeats the same URI:</p>
<div class="sourceCode" id="cb3" data-include="single.liq"><pre
class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">single</span>(<span class="st">&quot;/my/default.ogg&quot;</span>)</span></code></pre></div>
<p>A source which plays a playlist of requests – a playlist is a file
with an URI per line.</p>
<div class="sourceCode" id="cb4" data-include="playlists.liq"
data-to="END"><pre class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Shuffle, play every URI, start over.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="va">s1</span> = <span class="dt">playlist</span>(<span class="st">&quot;/my/playlist.txt&quot;</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Do not randomize</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="va">s2</span> = <span class="dt">playlist</span>(<span class="va">mode</span>=<span class="st">&quot;normal&quot;</span>, <span class="st">&quot;/my/pl.m3u&quot;</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># The playlist can come from any URI, can be reloaded every 10 minutes.</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="va">s3</span> = <span class="dt">playlist</span>(<span class="va">reload</span>=<span class="dv">600</span>, <span class="st">&quot;http://my/playlist.txt&quot;</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>When building your stream, you’ll often need to make it unfallible.
Usually, you achieve that using a fallback switch (see below) with a
branch made of a safe <code>single</code>. Roughly, a single is safe
when it is given a valid local audio file.</p>
<h2 id="transcoding"><a href="#transcoding"
class="anchor">Transcoding</a></h2>
<p><a href="index.html">Liquidsoap</a> can achieve basic streaming tasks
like transcoding with ease. You input any number of “source” streams
using <code>input.http</code>, and then transcode them to any number of
formats / bitrates / etc. The only limitation is your hardware: encoding
and decoding are both heavy on CPU. If you want to get the best use of
CPUs (multicore, memory footprint etc.) when encoding media with
Liquidsoap, we recommend using the <code>%ffmpeg</code> encoders.</p>
<div class="sourceCode" id="cb5" data-include="transcoding.liq"><pre
class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Input the stream from an Icecast server or any other source</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="va">url</span> = <span class="st">&quot;https://icecast.radiofrance.fr/fip-hifi.aac&quot;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="va">input</span> = <span class="dt">mksafe</span>(<span class="dt">input.http</span>(url))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># First transcoder: mp3 32 kbps. We also degrade the samplerate, and encode in</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># mono Accordingly, a mono conversion is performed on the input stream</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="dt">output.icecast</span>(</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">%mp3</span>(<span class="va">bitrate</span>=<span class="dv">32</span>, <span class="va">samplerate</span>=<span class="dv">22050</span>, <span class="va">stereo</span>=<span class="dv">false</span>),</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="va">mount</span>=<span class="st">&quot;/your-stream-32.mp3&quot;</span>,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="va">host</span>=<span class="st">&quot;streaming.example.com&quot;</span>, <span class="va">port</span>=<span class="dv">8000</span>, <span class="va">password</span>=<span class="st">&quot;xxx&quot;</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">mean</span>(input))</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Second transcoder: mp3 128 kbps using %ffmpeg</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="dt">output.icecast</span>(</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="ot">%ffmpeg</span>(<span class="va">format</span>=<span class="st">&quot;mp3&quot;</span>, <span class="ot">%audio</span>(<span class="va">codec</span>=<span class="st">&quot;libmp3lame&quot;</span>, <span class="va">b</span>=<span class="st">&quot;128k&quot;</span>)),</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="va">mount</span>=<span class="st">&quot;/your-stream-128.mp3&quot;</span>,</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="va">host</span>=<span class="st">&quot;streaming.example.com&quot;</span>, <span class="va">port</span>=<span class="dv">8000</span>, <span class="va">password</span>=<span class="st">&quot;xxx&quot;</span>,</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  input)</span></code></pre></div>
<h2 id="re-encoding-a-file"><a href="#re-encoding-a-file"
class="anchor">Re-encoding a file</a></h2>
<p>As a simple example using a fallible output, we shall consider
re-encoding a file. We start by building a source that plays our file
only once. That source is obviously fallible. We pass it to a file
output, which has to be in fallible mode. We also disable the
<code>sync</code> parameter on the source’s clock, to encode the file as
quickly as possible. Finally, we use the <code>on_stop</code> handler to
shutdown liquidsoap when streaming is finished.</p>
<div class="sourceCode" id="cb6" data-include="re-encode.liq"><pre
class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The input file, any format supported by liquidsoap</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="va">input</span> = <span class="st">&quot;/tmp/input.mp3&quot;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># The output file</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="va">target</span> = <span class="st">&quot;/tmp/output.ogg&quot;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># A source that plays the file once</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="va">source</span> = <span class="dt">once</span>(<span class="dt">single</span>(input))</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># We use a clock with disabled synchronization</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="dt">clock.assign_new</span>(<span class="va">sync</span>=<span class="st">&quot;none&quot;</span>, [source])</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Finally, we output the source to an ogg/vorbis file</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="dt">output.file</span>(<span class="ot">%vorbis</span>, target, <span class="va">fallible</span>=<span class="dv">true</span>, <span class="va">on_stop</span>=shutdown, source)</span></code></pre></div>
<h2 id="generating-cue-files"><a href="#generating-cue-files"
class="anchor">Generating CUE files</a></h2>
<p>When making backups of streams in audio files, it can be useful to
generate CUE files, which store the times where the various tracks occur
along with their metadata (those could then be used later on to split
the file for instance). This can be achieved using the
<code>source.cue</code> operator:</p>
<div class="sourceCode" id="cb7" data-include="source-cue.liq"
data-from="BEGIN" data-to="END"><pre
class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="va">radio</span> =</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">source.cue</span>(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">title</span>=</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;My stream&quot;</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">file</span>=<span class="st">&quot;backup.mp3&quot;</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;/tmp/backup.cue&quot;</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    radio</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="dt">output.file</span>(<span class="ot">%mp3</span>, <span class="st">&quot;/tmp/backup.mp3&quot;</span>, radio)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>which will generate a CUE file of the following form</p>
<pre><code>TITLE &quot;My stream&quot;
PERFORMER &quot;The performer&quot;
FILE &quot;backup.mp3&quot; MP3
  TRACK 01 AUDIO
    TITLE &quot;Title 1&quot;
    PERFORMER &quot;Artist 1&quot;
    INDEX 01 00:00:00
  TRACK 02 AUDIO
    TITLE &quot;Title 2&quot;
    PERFORMER &quot;Artist 2&quot;
    INDEX 01 01:12:67</code></pre>
<h2 id="rtmp-server"><a href="#rtmp-server" class="anchor">RTMP
server</a></h2>
<p>With our <a href="ffmpeg.html">FFmpeg support</a>, it is possible to
create a simple RTMP server with no re-encoding:</p>
<div class="sourceCode" id="cb9" data-include="rtmp.liq"><pre
class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="va">s</span> = <span class="dt">playlist</span>(<span class="st">&quot;my_playlist&quot;</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="va">enc</span> = <span class="ot">%ffmpeg</span>(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">format</span>=<span class="st">&quot;flv&quot;</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">listen</span>=<span class="dv">1</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">%audio</span>.copy,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">%video</span>.copy</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="dt">output.url</span>(<span class="va">url</span>=<span class="st">&quot;rtmp://host/app/instance&quot;</span>, enc, s)</span></code></pre></div>
<h2 id="transmitting-signal"><a href="#transmitting-signal"
class="anchor">Transmitting signal</a></h2>
<p>It is possible to send raw PCM signal between two instances using the
<a href="ffmpeg.html">FFmpeg encoder</a>. Here’s an example using the
SRT transport protocol:</p>
<p>Sender:</p>
<div class="sourceCode" id="cb10" data-include="srt-sender.liq"
data-from="BEGIN"><pre class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="va">enc</span> = <span class="ot">%ffmpeg</span>(<span class="va">format</span> = <span class="st">&quot;s16le&quot;</span>, <span class="ot">%audio</span>(<span class="va">codec</span> = <span class="st">&quot;pcm_s16le&quot;</span>, <span class="va">ac</span> = <span class="dv">2</span>, <span class="va">ar</span> = <span class="dv">48000</span>))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="dt">output.srt</span>(enc, s)</span></code></pre></div>
<p>Receiver:</p>
<div class="sourceCode" id="cb11" data-include="srt-receiver.liq"
data-to="END"><pre class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="va">s</span> =</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">input.srt</span>(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">content_type</span>=</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;application/ffmpeg;format=s16le,ch_layout=stereo,sample_rate=48000&quot;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<h2 id="scheduling"><a href="#scheduling"
class="anchor">Scheduling</a></h2>
<div class="sourceCode" id="cb12" data-include="fallback.liq"
data-to="END"><pre class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># A fallback switch</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="va">s</span> = <span class="dt">fallback</span>([<span class="dt">playlist</span>(<span class="st">&quot;http://my/playlist&quot;</span>), <span class="dt">single</span>(<span class="st">&quot;/my/jingle.ogg&quot;</span>)])</span></code></pre></div>
<div class="sourceCode" id="cb13" data-include="scheduling.liq"
data-from="BEGIN" data-to="END"><pre
class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># A scheduler, assuming you have defined the night and day sources</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="va">s</span> = <span class="dt">switch</span>([({<span class="dv">0</span>h<span class="dv">-7</span>h}, night), ({<span class="dv">7</span>h<span class="dv">-24</span>h}, day)])</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<h2 id="generating-playlists-from-a-media-library"><a
href="#generating-playlists-from-a-media-library"
class="anchor">Generating playlists from a media library</a></h2>
<p>In order to store all the metadata of the files in a given directory
and use those to generate playlists, you can use the
<code>medialib</code> operator which takes as argument the directory to
index. On first run, it will index all the files of the given folder,
which can take some time (you are advised to use the
<code>persistency</code> parameter in order to specify a file where
metadata will be stored to avoid reindexing at each run). The resulting
object can then be queried with the <code>find</code> method in order to
return all files matching the given conditions and thus generate a
playlist:</p>
<div class="sourceCode" id="cb14" data-include="medialib.liq"><pre
class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="va">m</span> = <span class="dt">medialib</span>(<span class="va">persistency</span>=<span class="st">&quot;/tmp/medialib.json&quot;</span>, <span class="st">&quot;~/music/&quot;</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="va">l</span> = <span class="dt">m.find</span>(<span class="va">artist_contains</span>=<span class="st">&quot;Brassens&quot;</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="va">l</span> = <span class="dt">list.shuffle</span>(l)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="dt">output</span>(<span class="dt">playlist.list</span>(l))</span></code></pre></div>
<p>The parameter of the <code>find</code> method follow the following
convention:</p>
<ul>
<li><code>artist="XXX"</code> looks for files where the artist tag is
exactly the given one</li>
<li><code>artist_contains="XXX"</code> looks for files where the artist
tag contains the given string as substring</li>
<li><code>artist_matches="XXX"</code> looks for files where the artist
tag matches the given regular expression (for instance
<code>artist_matches="(a)+.*(b)+"</code> looks for files where the
artist contains an <code>a</code> followed by a <code>b</code>).</li>
</ul>
<p>The tags for which such parameters are provided are:
<code>artist</code>, <code>title</code>, <code>album</code> and
<code>filename</code> (feel free to ask if you need more).</p>
<p>Some numeric tags are also supported:</p>
<ul>
<li><code>year=1999</code> looks for files where the year is exactly the
given one</li>
<li><code>year_ge=1999</code> looks for files where the year at least
the given one</li>
<li><code>year_lt=1999</code> looks for files where the year at most the
given one</li>
</ul>
<p>The following numeric tags are supported: <code>bpm</code>,
<code>year</code>.</p>
<p>If multiple arguments are passed, the function finds files with tags
matching the conjunction of the corresponding condition.</p>
<p>Finally, if you need more exotic search functions, the argument
<code>predicate</code> can be used. It takes as argument a
<em>predicate</em> which is a function taking the metadata of a file and
returning whether the file should be selected. For instance, the
following looks for files where the name of the artist is of length
5:</p>
<div class="sourceCode" id="cb15" data-include="medialib-predicate.liq"
data-from="BEGIN" data-to="END"><pre
class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="dt">p</span>(m)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">string.length</span>(m[<span class="st">&quot;artist&quot;</span>]) == <span class="dv">5</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="va">l</span> = <span class="dt">m.find</span>(<span class="va">predicate</span>=p)</span></code></pre></div>
<p>The default implementation of <code>medialib</code> uses standard
Liquidsoap functions and can be pretty expensive in terms of memory. A
more efficient implementation is available if you compiled with support
for sqlite3 databases. In this case, you can use the
<code>medialib.sqlite</code> operator as follows:</p>
<div class="sourceCode" id="cb16"
data-include="medialib.sqlite.liq"><pre
class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="va">m</span> = <span class="dt">medialib.sqlite</span>(<span class="va">database</span>=<span class="st">&quot;/tmp/medialib.sql&quot;</span>, <span class="st">&quot;~/music/&quot;</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="va">l</span> = <span class="dt">m.find</span>(<span class="va">artist_contains</span>=<span class="st">&quot;Brassens&quot;</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="va">l</span> = <span class="dt">list.shuffle</span>(l)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="dt">output</span>(<span class="dt">playlist.list</span>(l))</span></code></pre></div>
<p>(we also support more advanced uses of <a
href="database.html">databases</a>).</p>
<h2 id="force-a-fileplaylist-to-be-played-at-least-every-xx-minutes"><a
href="#force-a-fileplaylist-to-be-played-at-least-every-xx-minutes"
class="anchor">Force a file/playlist to be played at least every XX
minutes</a></h2>
<p>It can be useful to have a special playlist that is played at least
every 20 minutes for instance (3 times per hour). You may think of a
promotional playlist for instance. Here is the recipe:</p>
<div class="sourceCode" id="cb17" data-include="regular.liq"
data-from="BEGIN" data-to="END"><pre
class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># (1200 sec = 20 min)</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="va">timed_promotions</span> = <span class="dt">delay</span>(<span class="fl">1200.</span>, promotions)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="va">main_source</span> = <span class="dt">fallback</span>([timed_promotions, other_source])</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>Where promotions is a source selecting the file to be promoted.</p>
<h2 id="play-a-jingle-at-a-fixed-time"><a
href="#play-a-jingle-at-a-fixed-time" class="anchor">Play a jingle at a
fixed time</a></h2>
<p>Suppose that we have a playlist <code>jingles</code> of jingles and
we want to play one within the 5 first minutes of every hour, without
interrupting the current song. We can think of doing something like</p>
<div class="sourceCode" id="cb18" data-include="fixed-time1.liq"
data-from="BEGIN" data-to="END"><pre
class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="va">radio</span> = <span class="dt">switch</span>([({<span class="dv">0</span>m<span class="dv">-5</span>m}, jingles), ({<span class="dv">true</span>}, playlist)])</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>but the problem is that it is likely to play many jingles. In order
to play exactly one jingle, we can use the function
<code>predicate.activates</code> which detects when a predicate (here
<code>{ 0m-5m }</code>) becomes true:</p>
<div class="sourceCode" id="cb19" data-include="fixed-time2.liq"
data-from="BEGIN" data-to="END"><pre
class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="va">radio</span> = <span class="dt">switch</span>([(<span class="dt">predicate.activates</span>({<span class="dv">0</span>m<span class="dv">-5</span>m}), jingles), ({<span class="dv">true</span>}, playlist)])</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<h2 id="handle-special-events-mix-or-switch"><a
href="#handle-special-events-mix-or-switch" class="anchor">Handle
special events: mix or switch</a></h2>
<p>Add a jingle to your normal source at the beginning of every
hour:</p>
<div class="sourceCode" id="cb20" data-include="jingle-hour.liq"
data-from="BEGIN" data-to="END"><pre
class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="va">s</span> = <span class="dt">add</span>([normal, <span class="dt">switch</span>([({<span class="dv">0</span>m}, jingle)])])</span></code></pre></div>
<p>Switch to a live show as soon as one is available. Make the show
unavailable when it is silent, and skip tracks from the normal source if
they contain too much silence.</p>
<div class="sourceCode" id="cb21" data-include="switch-show.liq"
data-from="BEGIN" data-to="END"><pre
class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="va">stripped_stream</span> = <span class="dt">blank.strip</span>(<span class="dt">input.http</span>(<span class="st">&quot;http://myicecast:8080/live.ogg&quot;</span>))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="va">s</span> = <span class="dt">fallback</span>(<span class="va">track_sensitive</span>=<span class="dv">false</span>, [stripped_stream, <span class="dt">blank.strip</span>(normal)])</span></code></pre></div>
<p>Without the <code>track_sensitive=false</code> the fallback would
wait the end of a track to switch to the live. When using the blank
detection operators, make sure to fine-tune their <code>threshold</code>
and <code>length</code> (float) parameters.</p>
<h2 id="unix-interface-dynamic-requests"><a
href="#unix-interface-dynamic-requests" class="anchor">Unix interface,
dynamic requests</a></h2>
<p>Liquidsoap can create a source that uses files provided by the result
of the execution of any arbitrary function of your own. This is
explained in the documentation for <a
href="request_sources.html">request-based sources</a>.</p>
<p>For instance, the following snippet defines a source which repeatedly
plays the first valid URI in the playlist:</p>
<div class="sourceCode" id="cb22" data-include="request.dynamic.liq"
data-to="END"><pre class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="va">files</span> =</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">process.read.lines</span>(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;cat &quot;</span> ^</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">process.quote</span>(<span class="st">&quot;playlist.pls&quot;</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="va">pos</span> = <span class="dt">ref</span>(<span class="dv">0</span>)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="dt">get_next</span>() =</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">files</span> == []</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">then</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">null</span>()</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">else</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="va">file</span> = <span class="dt">list.nth</span>(files, <span class="dt">pos</span>())</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    pos := <span class="dt">pos</span>() + <span class="dv">1</span> mod <span class="dt">list.length</span>(files)</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">request.create</span>(file)</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="va">s</span> = <span class="dt">request.dynamic</span>(get_next)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>Of course a more interesting behaviour is obtained with a more
interesting program than <code>cat</code>, see <a
href="beet.html">Beets</a> for example.</p>
<p>Another way of using an external program is to define a new protocol
which uses it to resolve URIs. <code>protocol.add</code> takes a
protocol name, a function to be used for resolving URIs using that
protocol. The function will be given the URI parameter part and the time
left for resolving – though nothing really bad happens if you don’t
respect it. It usually passes the parameter to an external program ; it
is another way to integrate <a href="beet.html">Beets</a>, for
example:</p>
<div class="sourceCode" id="cb23"
data-include="beets-protocol-short.liq"><pre
class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="dt">protocol.add</span>(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;beets&quot;</span>,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">fun</span> (<span class="va">~rlog</span>=_, <span class="va">~maxtime</span>=_, arg) -&gt;</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">list.hd</span>(</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">process.read.lines</span>(</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;/home/me/path/to/beet random -f &#39;$path&#39; #{arg}&quot;</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>When resolving the URI <code>beets:David Bowie</code>, liquidsoap
will call the function, which will call
<code>beet random -f '$path' David Bowie</code> which will output the
path to a David Bowie song.</p>
<h2 id="dynamic-input-with-harbor"><a href="#dynamic-input-with-harbor"
class="anchor">Dynamic input with harbor</a></h2>
<p>The operator <code>input.harbor</code> allows you to receive a source
stream directly inside a running liquidsoap.</p>
<p>It starts a listening server on where any Icecast2-compatible source
client can connect. When a source is connected, its input if fed to the
corresponding source in the script, which becomes available.</p>
<p>This can be very useful to relay a live stream without polling the
Icecast server for it.</p>
<p>An example can be:</p>
<div class="sourceCode" id="cb24" data-include="harbor-dynamic.liq"><pre
class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Serveur settings</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>settings.harbor.bind_addrs := [<span class="st">&quot;0.0.0.0&quot;</span>]</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># An emergency file</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="va">emergency</span> = <span class="dt">single</span>(<span class="st">&quot;/path/to/emergency/single.ogg&quot;</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co"># A playlist</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="va">playlist</span> = <span class="dt">playlist</span>(<span class="st">&quot;/path/to/playlist&quot;</span>)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co"># A live source</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="va">live</span> = <span class="dt">input.harbor</span>(<span class="st">&quot;live&quot;</span>,<span class="va">port</span>=<span class="dv">8080</span>,<span class="va">password</span>=<span class="st">&quot;hackme&quot;</span>)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="co"># fallback</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="va">radio</span> = <span class="dt">fallback</span>(<span class="va">track_sensitive</span>=<span class="dv">false</span>, [live, playlist, emergency])</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="co"># output it</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="dt">output.icecast</span>(</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  <span class="ot">%vorbis</span>,</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  <span class="va">mount</span>=<span class="st">&quot;test&quot;</span>,</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>  <span class="va">host</span>=<span class="st">&quot;host&quot;</span>,</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  radio)</span></code></pre></div>
<p>This script, when launched, will start a local server, here bound to
“0.0.0.0”. This means that it will listen on any IP address available on
the machine for a connection coming from any IP address. The server will
wait for any source stream on mount point “/live” to login. Then if you
start a source client and tell it to stream to your server, on port
8080, with password “hackme”, the live source will become available and
the radio will stream it immediately.</p>
<h2 id="play-a-short-silence-when-transitioning-out-of-input.harbor"><a
href="#play-a-short-silence-when-transitioning-out-of-input.harbor"
class="anchor">Play a short silence when transitioning out of
<code>input.harbor</code></a></h2>
<p>If the live connection is unstable, for instance when streaming
through a roaming phone device, it can be interesting to add an extra
<code>5s</code> of silence when transitioning out of a live
<code>input.harbor</code> to give the input some chance to
reconnect.</p>
<p>This can be done with the <code>append</code> operator:</p>
<div class="sourceCode" id="cb25" data-include="append-silence.liq"
data-to="END"><pre class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The live source. We use a short buffer to switch more quickly to the source</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co"># when reconnecting.</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="va">live_source</span> = <span class="dt">input.harbor</span>(<span class="st">&quot;mount-point-name&quot;</span>, <span class="va">buffer</span>=<span class="fl">3.</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co"># A playlist source.</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="va">playlist_source</span> = <span class="dt">playlist</span>(<span class="st">&quot;/path/to/playlist&quot;</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Set to `true` when we should be adding silence.</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="va">should_append</span> = <span class="dt">ref</span>(<span class="dv">false</span>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Append 5. of silence when needed.</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="va">fallback_source</span> = <span class="dt">append</span>(</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  playlist_source, <span class="kw">fun</span> (_) -&gt;</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="dt">should_append</span>() <span class="kw">then</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>      should_append := <span class="dv">false</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">blank</span>(<span class="va">duration</span>=<span class="fl">5.</span>)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">source.fail</span>()</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Transition to live</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="dt">to_live</span>(playlist, live) =</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">sequence</span>([playlist,live])</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Transition back to playlist</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="dt">to_playlist</span>(live, playlist) =</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ask to insert a silent track.</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>  should_append := <span class="dv">true</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cancel current track. This will also set the playlist to play a new</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># track. If needed, `cancel_pending` can be used to for a new silent track</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># without skipping the playlist current track.</span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">fallback_source.skip</span>()</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>  <span class="dt">sequence</span>([live, playlist])</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a><span class="va">radio</span> = <span class="dt">fallback</span>(</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>  <span class="va">track_sensitive</span>=<span class="dv">false</span>,</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>  <span class="va">transitions</span>=[to_live, to_playlist],</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>  [live_source, fallback_source]</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<h2 id="dump-a-stream-into-segmented-files"><a
href="#dump-a-stream-into-segmented-files" class="anchor">Dump a stream
into segmented files</a></h2>
<p>It is sometimes useful (or even legally necessary) to keep a backup
of an audio stream. Storing all the stream in one file can be very
impractical. In order to save a file per hour in wav format, the
following script can be used:</p>
<div class="sourceCode" id="cb26" data-include="dump-hourly.liq"
data-from="BEGIN"><pre class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># A source to dump</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># s = ...</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Dump the stream</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="dt">output.file</span>(</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">%wav</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  {<span class="dt">time.string</span>(<span class="st">&quot;/archive/%Y-%m-%d/%Y-%m-%d-%H_%M_%S.mp3&quot;</span>)},</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  s,</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="va">reopen_when</span>={<span class="dv">0</span>m}</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Here, the function <code>time.string</code> generates the file name
by replacing <code>%H</code> by the hour, etc. The fact that it is
between curly brackets, i.e. <code>{time.string(...)}</code>, ensures
that it is re-evaluated each time a new file is created, the changing
the file name each time according to the current time.</p>
<p>In the following variant we write a new mp3 file each time new
metadata is coming from <code>s</code>:</p>
<div class="sourceCode" id="cb27" data-include="dump-hourly2.liq"
data-from="BEGIN"><pre class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="va">filename</span> =</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">time.string</span>(</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>      &#39;/archive/$(<span class="kw">if</span> $(title),<span class="st">&quot;$(title)&quot;</span>,<span class="st">&quot;Unknown \</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="st">       archive&quot;</span>)-<span class="ot">%Y</span>-<span class="ot">%m</span>-<span class="ot">%d</span>/<span class="ot">%Y</span>-<span class="ot">%m</span>-<span class="ot">%d</span>-<span class="ot">%H</span>_<span class="ot">%M</span>_<span class="ot">%S</span>.mp3&#39;</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="dt">output.file</span>(<span class="ot">%mp3</span>, filename, s, <span class="va">reopen_on_metadata</span>=<span class="kw">fun</span> (_) -&gt; <span class="dv">true</span>)</span></code></pre></div>
<p>In the two examples we use <a href="language.html">string
interpolation</a> and time literals to generate the output file
name.</p>
<p>In order to limit the disk space used by this archive, on unix
systems we can regularly call <code>find</code> to cleanup the folder;
if we can to keep 31 days of recording:</p>
<div class="sourceCode" id="cb28"
data-include="archive-cleaner.liq"><pre
class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="dt">thread.run</span>(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">every</span>=<span class="fl">3600.</span>,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">list.iter</span>(</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">fun</span> (msg) -&gt; <span class="dt">log</span>(msg, <span class="va">label</span>=<span class="st">&quot;archive_cleaner&quot;</span>),</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">list.append</span>(</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">process.read.lines</span>(</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;find /archive/* -type f -mtime +31 -delete&quot;</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">process.read.lines</span>(</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;find /archive/* -type d -empty -delete&quot;</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<h2 id="transitions"><a href="#transitions"
class="anchor">Transitions</a></h2>
<p>There are two kinds of transitions. Transitions between two different
children of a switch or fallback and transitions between tracks of the
same source.</p>
<h3 id="switch-based-transitions"><a href="#switch-based-transitions"
class="anchor">Switch-based transitions</a></h3>
<p>The switch-based operators (<code>switch</code>,
<code>fallback</code> and <code>random</code>) support transitions. For
every child, you can specify a transition function computing the output
stream when moving from one child to another. This function is given two
<code>source</code> parameters: the child which is about to be left, and
the new selected child. The default transition is
<code>fun (a,b) -&gt; b</code>, it simply relays the new selected child
source.</p>
<p>One limitation of these transitions, however, is that if the
transition happen right at the end of a track, which is the default with
<code>track_sensitive=true</code>, then there is no more data available
for the old source, which makes it impossible to fade it out. If that is
what you are expecting, you should look at crossfade-based
transitions</p>
<h3 id="crossfade-based-transitions"><a
href="#crossfade-based-transitions" class="anchor">Crossfade-based
transitions</a></h3>
<p>Crossfade-based transitions are more complex and involve buffering
source data in advance to be able to compute a transition where ending
and starting track potentially overlap. This does not work with all type
of sources since some of them, such as <code>input.http</code> may only
receive data at real-time rate and cannot be accelerated to buffer their
data or else we risk running out of data.</p>
<p>We provide a default operator named <code>cross.simple</code>
transition which may be suitable for most usage. But you can also create
your own customized crossfade transitions. This is in particular true if
you are expecting crossfade transitions between tracks of your
<code>music</code> source but not between a <code>music</code> track and
e.g. some jingles. Here’s how to do it in this case:</p>
<div class="sourceCode" id="cb29" data-include="cross.custom.liq"
data-from="BEGIN" data-to="END"><pre
class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># A function to add a source_tag metadata to a source:</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="dt">source_tag</span>(s, tag) =</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="dt">f</span>(_) =</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    [(<span class="st">&quot;source_tag&quot;</span>, (tag : string))]</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">metadata.map</span>(<span class="va">id</span>=tag, <span class="va">insert_missing</span>=<span class="dv">true</span>, f, s)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Tag our sources</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="va">music</span> = <span class="dt">source_tag</span>(music, <span class="st">&quot;music&quot;</span>)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="va">jingles</span> = <span class="dt">source_tag</span>(jingles, <span class="st">&quot;jingles&quot;</span>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine them with one jingle every 3 music tracks</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="va">radio</span> = <span class="dt">rotate</span>(<span class="va">weights</span>=[<span class="dv">1</span>, <span class="dv">3</span>], [jingles, music])</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Now a custom crossfade transition:</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="dt">transition</span>(a, b) =</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If old or new source is not music, no fade</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    a.metadata[<span class="st">&quot;source_tag&quot;</span>] != <span class="st">&quot;music&quot;</span> <span class="kw">or</span> a.metadata[<span class="st">&quot;source_tag&quot;</span>] != <span class="st">&quot;music&quot;</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">then</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">sequence</span>([a.source, b.source])</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">else</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Else, apply the standard transition</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">cross.simple</span>(a.source, b.source)</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply it!</span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a><span class="va">radio</span> = <span class="dt">cross</span>(<span class="va">duration</span>=<span class="fl">5.</span>, transition, radio)</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<h2 id="alsa-output-delay"><a href="#alsa-output-delay"
class="anchor">Alsa output delay</a></h2>
<p>You can use <a href="index.html">Liquidsoap</a> to capture and play
through alsa with a minimal delay. This particularly useful when you
want to run a live show from your computer. You can then directly
capture and play audio through external speakers without delay for the
DJ !</p>
<p>This configuration is not trivial since it relies on your hardware.
Some hardware will allow both recording and playing at the same time,
some only one at once, and some none at all.. Those note to configure
are what works for us, we don’t know if they’ll fit all hardware.</p>
<p>First launch liquidsoap as a one line program</p>
<pre><code>liquidsoap -v --debug &#39;input.alsa()&#39;</code></pre>
<p>Unless you’re lucky, the logs are full of lines like the
following:</p>
<pre><code>Could not set buffer size to &#39;frame.size&#39; (1920 samples), got 2048.</code></pre>
<p>The solution is then to set liquidsoap’s internal frame size to this
value, which is most likely specific to your hardware. Let’s try this
script:</p>
<div class="sourceCode" id="cb32" data-include="frame-size.liq"><pre
class="sourceCode liquidsoap"><code class="sourceCode liquidsoap"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ot">%ifndef input.alsa</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">input.alsa</span> = blank</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="ot">%endif</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="ot">%ifndef output.alsa</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">output.alsa</span> = output.dummy</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="ot">%endif</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co"># BEGIN</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Set correct frame size:</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co"># This makes it possible to set any audio frame size.</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure that you do NOT use video in this case!</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>video.frame.rate := <span class="dv">0</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Now set the audio frame size exactly as required:</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>settings.frame.audio.size := <span class="dv">2048</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="va">input</span> = <span class="dt">input.alsa</span>()</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="dt">output.alsa</span>(input)</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="co"># END</span></span></code></pre></div>
<p>The setting will be acknowledged in the log as follows:</p>
<pre><code>Targeting &#39;frame.audio.size&#39;: 2048 audio samples = 2048 ticks.</code></pre>
<p>If everything goes right, you may hear on your output the captured
sound without any delay!</p>
<p>If you experience problems it might be a good idea to double the
value of the frame size. This increases stability, but also latency.</p>
          <div id="footer"></div>
        </main>
      </div>
    </div>
    <!--   Core JS Files   -->

    <script src="/assets/js/core/jquery.min.js" type="text/javascript"></script>
    <script src="/assets/js/core/popper.min.js" type="text/javascript"></script>
    <script src="/assets/js/core/bootstrap-material-design.min.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript"></script>
    <script src="/assets/js/liq-jquery.js" type="text/javascript"></script>
  </body>

</html>
